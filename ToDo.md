# TODO

## 1. Общие исправления и архитектура

### Зависимости и запуск
- Исправить зависимости: `fastpai==0.103` → `fastapi==0.103.*`.
- Согласовать версии `pydantic` и `FastAPI`.
- Закрепить версии (`~=`) или перейти на Poetry/lockfile.

### CORS и безопасность API
- В `main.py` ограничить `allow_origins` доменами продакшена.
- Включить `allow_credentials=True` при cookie-сессиях.

### Конфигурация API-хоста
- Убрать хардкод `ApiUrlPath = 'http://localhost:8000'` из `frontend/src/utils/api.ts`.
- Перенести URL в `.env`, реализовать dev/prod профили.

### Авторизация и безопасность
- Заменить текущую проверку по `Authorization: <uuid>` на JWT (access/refresh) или cookie-сессию.
- Добавить роли и права: `admin`, `cashier`, `operator`.

### Пароли и админ-доступ
- Перепроверить схему хранения хэшей (отдельная таблица админов).
- Хранить пароли через `bcrypt`.
- Добавить политику смены паролей и блокировки.

### Схема БД и миграции
- Перейти с SQLite на PostgreSQL.
- Добавить Alembic и скрипты инициализации.

### Логи и мониторинг
- Добавить эндпоинты `/healthz` и `/readyz`.
- Настроить структурные логи (JSON), уровни логирования per-router.
- Добавить ротацию логов.

### Процессы и фоновые задачи
- Заменить `multiprocessing.Process(device_session_checker)` на APScheduler/Celery/background tasks.

### Валидация данных
- Перепроверить модели `assets/models/*`.
- Добавить типизацию, ограничения, человекочитаемые ошибки.

### UX и интерфейс
- Унифицировать обработку ошибок (ErrorBoundary, toasts).
- Добавить спиннеры и откат действий при сетевых ошибках.

---

## 2. Backend

### Роли и права
- Внедрить RBAC через `fastapi.Depends`.
- Настроить scopes в JWT и аудит действий (кто/что/когда).

### Идемпотентность и транзакции
- Обернуть ключевые операции (оплата, сессия) в транзакции.
- Ввести идемпотентные ключи для повторных запросов.

### Инвентарь и касса
- Разделить сущности: товар, движение, чек, позиция чека.
- Корректно считать себестоимость и списания.

### Отчёты
- Реализовать агрегаты за период: выручка, возвраты, кассовый баланс.

### WebSockets
- Перевести статус ПК, таймеры и витрину на WebSocket канал.

### Масштабирование
- Настроить `docker-compose` (backend, frontend, postgres, redis, nginx).
- Реализовать миграции на старте контейнера.

---

## 3. Frontend

### Состояние и API
- Перейти на Redux Toolkit + RTK Query.
- Добавить кэширование и optimistic updates.

### UI и дизайн
- Унифицировать таблицы, модалки, формы.
- Ввести дизайн-токены (темы, отступы, размеры).

### PWA и офлайн-режим
- Добавить офлайн-кеширование для базовых операций.

### Интернационализация
- Реализовать `i18n` (ru/en) с `react-i18next`.

### Качество и тестирование
- Тесты: `pytest`, `TestClient` (backend), React Testing Library, Cypress (frontend).
- Настроить GitHub Actions (линтеры, тесты, сборка, деплой).

---

## 4. Онлайн-бронирование и расширения

### Бронирование мест
- Добавить сетку зала, слоты времени, динамическое ценообразование.
- Реализовать предоплату.

### Личный кабинет
- Баланс, история сессий, QR-вход, продление с телефона.

### Лояльность и тарифы
- Абонементы, подписки, бонусные пакеты, промокоды, реферальная программа.

### Турниры и события
- Регистрация, сетка, начисление бонусов и афиша событий.

### Поддержка устройств
- PS/Xbox/VR — отдельные типы устройств с тарифами и аксессуарами.

### POS-функциональность
- Сканер штрих-кодов, печать чеков, фискализация, карточки клиентов.

### Уведомления
- Telegram/Email/Push: уведомления о времени, балансе, брони, остатках.

### Аналитика
- Метрики LTV, загрузка зала, A/B тарифов, топ-товары, экспорт CSV.

### Мультифилиалы и интеграции
- Общие товары, отдельные склады, общая аналитика.
- Интеграции: платежи, Google Sheets, Sentry, Prometheus/Grafana.

---

## 5. Безопасность и политика доступа

- JWT + refresh, ротация токенов, scopes.
- Ограничение CORS, HTTPS, HSTS, защита от CSRF.
- Rate-limit и reCAPTCHA для логина/сброса пароля.
- Резервные копии БД и автоматизация Alembic.
- Аудит действий пользователей.
- Ролевая модель: кассир, старший смены, админ, владелец.
- Полная валидация всех входящих данных.

---

## 6. Улучшения UX

- Горячие клавиши для операций (старт/пауза/продление/чек).
- Поиск и массовые действия по ПК/товарам.
- Undo/redo и мягкие отмены.
- Таймеры и всплывающие подсказки через WebSocket.
- Доступность (a11y), высокая контрастность для кассы.

---

## 7. Roadmap

1. **Базовые правки**
   - Deps, CORS, `.env`, Docker Compose, PostgreSQL, Alembic.
2. **Безопасность и авторизация**
   - JWT, роли, миграция логики логина.
3. **Frontend**
   - RTK Query для ключевых экранов (ПК, касса, склад).
4. **Реальное время**
   - WebSocket для статусов ПК и таймеров.
5. **Отчётность**
   - Касса, смены, аудит.
6. **Тестирование**
   - E2E критических сценариев.
7. **Расширения**
   - Бронирование, тарифы, PWA.
8. **Дополнительно**
   - Лояльность, уведомления, аналитика, мультифилиалы.

